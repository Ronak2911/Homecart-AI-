{% extends 'base/base.html' %}
{% block title %}Visit Management{% endblock %}

{% block body %}

<div class="container-fluid py-4">

  <!-- DASHBOARD STATS -->
  <div class="row g-3 mb-4">

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Total Visits</small>
          <h4 class="fw-bold mb-0">{{ visits|length }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Confirmed</small>
          <h4 class="fw-bold text-success mb-0">
            {{ visits|selectattr("status","equalto","Confirmed")|list|length }}
          </h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Pending</small>
          <h4 class="fw-bold text-warning mb-0">
            {{ visits|selectattr("status","equalto","Pending")|list|length }}
          </h4>
        </div>
      </div>
    </div>

  </div>


  <!-- SEARCH + FILTER -->
  <div class="card shadow-sm border-0 mb-3">

    <div class="card-body">

      <form method="GET" class="row g-2">

        <!-- SEARCH -->
        <div class="col-md-4">

          <input type="text"
                 name="search"
                 class="form-control form-control-sm shadow-sm"
                 placeholder="Search customer or property...">

        </div>

        <!-- STATUS -->
        <div class="col-md-3">

          <select name="status"
                  class="form-select form-select-sm shadow-sm">

            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>

          </select>

        </div>

        <!-- BUTTON -->
        <div class="col-md-2">

          <button class="btn btn-primary btn-sm w-100">

            Search

          </button>

        </div>

      </form>

    </div>

  </div>


  <!-- VISITS TABLE -->
  <div class="card border-0 shadow-sm">

    <div class="table-responsive">

      <table class="table table-hover align-middle mb-0">

        <thead class="table-light">

          <tr>

            <th>Customer</th>
            <th>Property</th>
            <th>Visit Type</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>

            {% if user.role == "admin" %}
            <th>Staff</th>
            <th>Action</th>
            {% endif %}

          </tr>

        </thead>

        <tbody>

        {% for v in visits %}

          <tr>

            <td class="fw-semibold">

              {{ v.customer_name }}

            </td>


            <td>

              {{ v.property_title }}

            </td>


            <td>

              <span class="badge bg-secondary">

                {{ v.visittype }}

              </span>

            </td>


            <td>

              {{ v.preferreddate }}

            </td>


            <td>

              {{ v.preferredtime }}

            </td>


            <!-- STATUS DROPDOWN -->
            <td>

              <form method="POST"
                    action="/visit/update-status/{{ v._id }}">

                <select name="status"
                        class="form-select form-select-sm"

                        onchange="this.form.submit()">

                  <option value="Pending"
                    {% if v.status=="Pending" %}selected{% endif %}>
                    Pending
                  </option>

                  <option value="Confirmed"
                    {% if v.status=="Confirmed" %}selected{% endif %}>
                    Confirmed
                  </option>

                </select>

              </form>

            </td>


            {% if user.role=="admin" %}

            <td>

              {% if v.staff_name %}

                <span class="badge bg-info">

                  {{ v.staff_name }}

                </span>

              {% else %}

                <span class="text-muted">

                  Unassigned

                </span>

              {% endif %}

            </td>


            <!-- ASSIGN BUTTON -->
            <td>

              <button class="btn btn-sm btn-outline-primary"

                      data-bs-toggle="modal"
                      data-bs-target="#assignModal{{ v._id }}">

                Assign

              </button>

            </td>

            {% endif %}

          </tr>


          <!-- ASSIGN STAFF MODAL -->
          <div class="modal fade"
               id="assignModal{{ v._id }}">

            <div class="modal-dialog">

              <form method="POST"
                    action="/visit/assign/{{ v._id }}">

                <div class="modal-content">

                  <div class="modal-header">

                    <h5 class="modal-title">

                      Assign Staff

                    </h5>

                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal">

                    </button>

                  </div>


                  <div class="modal-body">

                    <select name="staff_id"
                            class="form-select">

                      {% for s in staff %}

                      <option value="{{ s._id }}">

                        {{ s.name }}

                      </option>

                      {% endfor %}

                    </select>

                  </div>


                  <div class="modal-footer">

                    <button class="btn btn-primary">

                      Assign

                    </button>

                  </div>

                </div>

              </form>

            </div>

          </div>


        {% endfor %}

        </tbody>

      </table>

    </div>

  </div>


  <!-- PAGINATION -->
  <nav class="mt-3">

    <ul class="pagination pagination-sm justify-content-end">

      <li class="page-item">
        <a class="page-link" href="#">Previous</a>
      </li>

      <li class="page-item active">
        <a class="page-link" href="#">1</a>
      </li>

      <li class="page-item">
        <a class="page-link" href="#">2</a>
      </li>

      <li class="page-item">
        <a class="page-link" href="#">Next</a>
      </li>

    </ul>

  </nav>


</div>

{% endblock %}
